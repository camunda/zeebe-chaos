<!doctype html>
<html lang="en" dir="ltr" class="blog-wrapper blog-post-page plugin-blog plugin-id-default" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.0.1">
<title data-rh="true">Disconnect Leader and one Follower | Zeebe Chaos</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://zeebe-io.github.io/zeebe-chaos/2021/01/07/disconnect-leader-and-follower"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docusaurus_tag" content="default"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docsearch:docusaurus_tag" content="default"><meta data-rh="true" property="og:title" content="Disconnect Leader and one Follower | Zeebe Chaos"><meta data-rh="true" name="description" content="Happy new year everyone"><meta data-rh="true" property="og:description" content="Happy new year everyone"><meta data-rh="true" property="og:type" content="article"><meta data-rh="true" property="article:published_time" content="2021-01-07T00:00:00.000Z"><meta data-rh="true" property="article:author" content="https://github.com/zelldon"><meta data-rh="true" property="article:tag" content="availability"><link data-rh="true" rel="icon" href="/zeebe-chaos/img/zeebe-logo.png"><link data-rh="true" rel="canonical" href="https://zeebe-io.github.io/zeebe-chaos/2021/01/07/disconnect-leader-and-follower"><link data-rh="true" rel="alternate" href="https://zeebe-io.github.io/zeebe-chaos/2021/01/07/disconnect-leader-and-follower" hreflang="en"><link data-rh="true" rel="alternate" href="https://zeebe-io.github.io/zeebe-chaos/2021/01/07/disconnect-leader-and-follower" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/zeebe-chaos/rss.xml" title="Zeebe Chaos RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/zeebe-chaos/atom.xml" title="Zeebe Chaos Atom Feed"><link rel="stylesheet" href="/zeebe-chaos/assets/css/styles.ab1e5a6e.css">
<script src="/zeebe-chaos/assets/js/runtime~main.45fb8ea2.js" defer="defer"></script>
<script src="/zeebe-chaos/assets/js/main.c1f3aab9.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/zeebe-chaos/"><div class="navbar__logo"><img src="/zeebe-chaos/img/zeebe-logo.png" alt="Zeebe" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/zeebe-chaos/img/zeebe-logo.png" alt="Zeebe" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">Zeebe Chaos</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/zeebe-chaos/">Chaos Summaries</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/zeebe-io/zeebe-chaos" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_re4s thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_pO2u margin-bottom--md">All posts</div><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zeebe-chaos/2024/01/19/Job-Activation-Latency">Reducing the job activation delay</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zeebe-chaos/2023/12/20/Broker-scaling-performance">Broker Scaling and Performance</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zeebe-chaos/2023/12/19/Dynamic-Scaling-with-Dataloss">Dynamic Scaling with Dataloss</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zeebe-chaos/2023/12/18/Dynamically-scaling-brokers">Dynamically scaling brokers</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zeebe-chaos/2023/12/06/Job-Push-resiliency">Job push resiliency</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zeebe-chaos/2023/11/30/Job-push-overloading">Job push overloading</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zeebe-chaos/2023/11/07/Hot-backups-impact-on-processing">Hot backups impact on processing</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zeebe-chaos/2023/06/02/Using-Large-Multi-Instance">Using Large Multi-Instance</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zeebe-chaos/2023/05/19/Continuing-SST-Partitioning-toggle">Continuing SST Partitioning toggle</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zeebe-chaos/2023/05/15/SST-Partitioning-toggle">SST Partitioning toggle</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zeebe-chaos/2023/04/06/gateway-termination">Gateway Termination</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zeebe-chaos/2023/02/23/Recursive-call-activity">Recursive call activity</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zeebe-chaos/2022/08/31/Message-Correlation-after-Network-Partition">Message Correlation after Network Partition</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zeebe-chaos/2022/08/02/deployment-distribution">Bring Deployment distribution experiment back</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zeebe-chaos/2022/02/15/Standalone-Gateway-in-CCSaaS">Standalone Gateway in CCSaaS</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zeebe-chaos/2022/02/01/High-Snapshot-Frequency">High Snapshot Frequency</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zeebe-chaos/2022/01/19/big-variables">Handling of Big Variables</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zeebe-chaos/2021/11/24/Worker-count-should-not-impact-performance">Worker count should not impact performance</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zeebe-chaos/2021/11/11/Not-produce-duplicate-Keys">Not produce duplicate Keys</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zeebe-chaos/2021/10/29/Throughput-on-big-state">Throughput on big state</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zeebe-chaos/2021/10/05/recovery-time">Recovery (Fail Over) time</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zeebe-chaos/2021/09/23/Old-Clients">Old-Clients</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zeebe-chaos/2021/07/06/Slow-Network">Slow Network</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zeebe-chaos/2021/06/08/Full-Disk">Full Disk Recovery</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zeebe-chaos/2021/05/25/Reset-Clock">Time travel Experiment</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zeebe-chaos/2021/04/29/Corrupted-Snapshot">Corrupted Snapshot Experiment Investigation</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zeebe-chaos/2021/04/03/bpmn-meets-chaos-engineering">BPMN meets Chaos Engineering</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zeebe-chaos/2021/03/30/set-file-immutable">Set file immutable</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zeebe-chaos/2021/03/23/camunda-cloud-network-partition">Camunda Cloud network partition</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zeebe-chaos/2021/03/09/cont-workflow-instance">Fault-tolerant processing of process instances</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zeebe-chaos/2021/02/23/automate-deployments-dist">Automating Deployment Distribution Chaos Experiment</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zeebe-chaos/2021/01/26/deployments">Deployment Distribution</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zeebe-chaos/2021/01/19/network-partition">Network partitions</a></li><li class="sidebarItem__DBe"><a aria-current="page" class="sidebarItemLink_mo7H sidebarItemLinkActive_I1ZP" href="/zeebe-chaos/2021/01/07/disconnect-leader-and-follower">Disconnect Leader and one Follower</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zeebe-chaos/2020/11/24/message-correlation-after-failover">Message Correlation after Failover</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zeebe-chaos/2020/11/11/job-timeouts">Many Job Timeouts</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zeebe-chaos/2020/11/03/investigate-failing-tests">Investigate failing Chaos Tests</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zeebe-chaos/2020/10/20/non-graceful-shutdown">Non-graceful Shutdown Broker</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zeebe-chaos/2020/10/27/standalone-gw-memory">Gateway memory consumption</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zeebe-chaos/2020/10/13/multiple-leader-changes">Multiple Leader Changes</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zeebe-chaos/2020/10/06/toxi-proxy">Play around with ToxiProxy</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zeebe-chaos/2020/08/20/experiment-with-camunda-cloud">Experiment with Camunda Cloud</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zeebe-chaos/2020/08/06/low-load">Experiment with Low Load</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zeebe-chaos/2020/07/30/experiment-without-exporters">Experiment without Exporters</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zeebe-chaos/2020/07/16/big-multi-instance">Big Multi Instance</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zeebe-chaos/2020/07/09/timer-and-huge-variables">Experiment with Timers and Huge Variables</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zeebe-chaos/2020/07/02/extract-k8-resources">Extract K8 resources from namespace</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zeebe-chaos/2020/06/25/gateway-network-partition">Gateway Network Partition</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zeebe-chaos/2020/06/18/correlate-message-after-failover">Correlate Message after failover</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zeebe-chaos/2020/06/11/high-cpu-gateway">High CPU load on Standalone Gateway</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zeebe-chaos/2020/06/04/first-chaos-day">First Chaos Day!</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="https://schema.org/Blog"><article itemprop="blogPost" itemscope="" itemtype="https://schema.org/BlogPosting"><meta itemprop="description" content="Happy new year everyone"><header><h1 class="title_f1Hy" itemprop="headline">Disconnect Leader and one Follower</h1><div class="container_mt6G margin-vert--md"><time datetime="2021-01-07T00:00:00.000Z" itemprop="datePublished">January 7, 2021</time> · <!-- -->8 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://github.com/zelldon" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://github.com/zelldon.png" alt="Christopher Kujawa" itemprop="image"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/zelldon" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Christopher Kujawa</span></a></div><small class="avatar__subtitle" itemprop="description">Chaos Engineer @ Zeebe</small></div></div></div></div></header><div id="__blog-post-container" class="markdown" itemprop="articleBody"><p>Happy new year everyone <!-- -->🎉</p>
<p>This time I wanted to verify the following hypothesis <code>Disconnecting Leader and one Follower should not make cluster disruptive</code> (<a href="https://github.com/zeebe-io/zeebe-chaos/issues/45" target="_blank" rel="noopener noreferrer">#45</a>).
But in order to do that we need to extract the Leader and Follower node for a partition from the Topology. Luckily in December we got an <a href="https://github.com/zeebe-io/zeebe/pull/5943" target="_blank" rel="noopener noreferrer">external contribution</a> which allows us to print <code>zbctl status</code> as json.
This gives us now more possibilities, since we can extract values much better out of it.</p>
<p><strong>TL;DR</strong> The experiment was successful <!-- -->👍</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="preparation">Preparation<a href="#preparation" class="hash-link" aria-label="Direct link to Preparation" title="Direct link to Preparation">​</a></h2>
<p>Before we start with the experiment I wanted to extract the right node id&#x27;s for the follower&#x27;s and leader from the <code>zbctl status</code> output via <code>jq</code>. If we have that we can use this for other use cases.</p>
<p>I stored the <code>zbctl</code> json output in a file, to make the lines a bit more readable and that I can focus on the jq stuff. The tested output looks like this:</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ cat test.json </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;brokers&quot;: [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      &quot;nodeId&quot;: 1,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      &quot;host&quot;: &quot;zeebe-chaos-zeebe-1.zeebe-chaos-zeebe.zeebe-chaos.svc.cluster.local&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      &quot;port&quot;: 26501,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      &quot;partitions&quot;: [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          &quot;partitionId&quot;: 1,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          &quot;role&quot;: &quot;LEADER&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          &quot;health&quot;: &quot;HEALTHY&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          &quot;partitionId&quot;: 2,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          &quot;role&quot;: &quot;FOLLOWER&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          &quot;health&quot;: &quot;HEALTHY&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          &quot;partitionId&quot;: 3,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          &quot;role&quot;: &quot;LEADER&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          &quot;health&quot;: &quot;HEALTHY&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          &quot;partitionId&quot;: 4,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          &quot;role&quot;: &quot;LEADER&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          &quot;health&quot;: &quot;HEALTHY&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      ],</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      &quot;version&quot;: &quot;0.27.0-SNAPSHOT&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      &quot;nodeId&quot;: 2,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      &quot;host&quot;: &quot;zeebe-chaos-zeebe-2.zeebe-chaos-zeebe.zeebe-chaos.svc.cluster.local&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      &quot;port&quot;: 26501,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      &quot;partitions&quot;: [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          &quot;partitionId&quot;: 1,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          &quot;role&quot;: &quot;FOLLOWER&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          &quot;health&quot;: &quot;HEALTHY&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          &quot;partitionId&quot;: 2,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          &quot;role&quot;: &quot;LEADER&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          &quot;health&quot;: &quot;HEALTHY&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          &quot;partitionId&quot;: 3,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          &quot;role&quot;: &quot;FOLLOWER&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          &quot;health&quot;: &quot;HEALTHY&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          &quot;partitionId&quot;: 4,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          &quot;role&quot;: &quot;FOLLOWER&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          &quot;health&quot;: &quot;HEALTHY&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      ],</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      &quot;version&quot;: &quot;0.27.0-SNAPSHOT&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      &quot;nodeId&quot;: 0,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      &quot;host&quot;: &quot;zeebe-chaos-zeebe-0.zeebe-chaos-zeebe.zeebe-chaos.svc.cluster.local&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      &quot;port&quot;: 26501,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      &quot;partitions&quot;: [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          &quot;partitionId&quot;: 1,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          &quot;role&quot;: &quot;FOLLOWER&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          &quot;health&quot;: &quot;HEALTHY&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          &quot;partitionId&quot;: 2,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          &quot;role&quot;: &quot;FOLLOWER&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          &quot;health&quot;: &quot;HEALTHY&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          &quot;partitionId&quot;: 3,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          &quot;role&quot;: &quot;FOLLOWER&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          &quot;health&quot;: &quot;HEALTHY&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          &quot;partitionId&quot;: 4,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          &quot;role&quot;: &quot;FOLLOWER&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          &quot;health&quot;: &quot;HEALTHY&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      ],</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      &quot;version&quot;: &quot;0.27.0-SNAPSHOT&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ],</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;clusterSize&quot;: 3,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;partitionsCount&quot;: 4,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;replicationFactor&quot;: 3,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;gatewayVersion&quot;: &quot;0.27.0-SNAPSHOT&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>I had a really hard time to find the correct <code>jq</code> expression, but here is it:</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ cat test.json | jq &quot;.brokers[]|select(.partitions[]| select(.partitionId == 3) and .role == \&quot;LEADER\&quot;)&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>You may ask why there are multiple <a href="https://stedolan.github.io/jq/manual/#select(boolean_expression)" target="_blank" rel="noopener noreferrer">selects</a>. I tried it previous with one and the issue is that it then works like an cartesian-product. It takes broker objects, which take part of the partition 3 and it will take broker objects, which are leader for an partition into the output. This is obviously not that what I want.
The current expression filters brokers for partitions which have the partitionId and are leader for that partition. This <a href="https://gist.github.com/olih/f7437fb6962fb3ee9fe95bda8d2c8fa4#gistcomment-3257810" target="_blank" rel="noopener noreferrer">gist comment</a> helped me here.</p>
<p>Examples:</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ cat test.json | jq &quot;.brokers[]|select(.partitions[]| select(.partitionId == 3) and .role == \&quot;LEADER\&quot;)|.nodeId&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ cat test.json | jq &quot;.brokers[]|select(.partitions[]| select(.partitionId == 2) and .role == \&quot;LEADER\&quot;)|.nodeId&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Later I realized that this doesn&#x27;t work for followers, since you can have multiple ones, BUT also this can be solved. <a href="https://stackoverflow.com/questions/38500363/get-the-first-or-nth-element-in-a-jq-json-parsing" target="_blank" rel="noopener noreferrer">Just put it in an array and get the first entry</a>.</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">jq &quot;[.brokers[]|select(.partitions[]| select(.partitionId == $partition) and .role == \&quot;$state\&quot;)][0].nodeId</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>As you can see <code>jq</code> is quite powerful and I learned a lot about it this day. If you interested you can also check <a href="https://stedolan.github.io/jq/manual/" target="_blank" rel="noopener noreferrer">the manual</a> which has ton&#x27;s of examples.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="resources">Resources<a href="#resources" class="hash-link" aria-label="Direct link to Resources" title="Direct link to Resources">​</a></h3>
<ul>
<li><a href="https://stackoverflow.com/questions/18592173/select-objects-based-on-value-of-variable-in-object-using-jq" target="_blank" rel="noopener noreferrer">https://stackoverflow.com/questions/18592173/select-objects-based-on-value-of-variable-in-object-using-jq</a></li>
<li><a href="https://unix.stackexchange.com/questions/404699/using-multiple-wildcards-in-jq-to-select-objects-in-a-json-file" target="_blank" rel="noopener noreferrer">https://unix.stackexchange.com/questions/404699/using-multiple-wildcards-in-jq-to-select-objects-in-a-json-file</a></li>
<li><a href="https://stedolan.github.io/jq/manual/#Builtinoperatorsandfunctions" target="_blank" rel="noopener noreferrer">https://stedolan.github.io/jq/manual/#Builtinoperatorsandfunctions</a></li>
<li><a href="https://stackoverflow.com/questions/33057420/jq-select-multiple-conditions" target="_blank" rel="noopener noreferrer">https://stackoverflow.com/questions/33057420/jq-select-multiple-conditions</a></li>
<li><a href="https://github.com/stedolan/jq/issues/319" target="_blank" rel="noopener noreferrer">https://github.com/stedolan/jq/issues/319</a></li>
<li><a href="https://unix.stackexchange.com/questions/491669/jq-get-attribute-of-nested-object" target="_blank" rel="noopener noreferrer">https://unix.stackexchange.com/questions/491669/jq-get-attribute-of-nested-object</a></li>
<li><a href="https://stackoverflow.com/questions/27562424/jq-nested-object-extract-top-level-id-and-lift-a-value-from-internal-object" target="_blank" rel="noopener noreferrer">https://stackoverflow.com/questions/27562424/jq-nested-object-extract-top-level-id-and-lift-a-value-from-internal-object</a></li>
<li><em>false track</em> <a href="https://stackoverflow.com/questions/28615174/jq-filter-on-sub-object-value" target="_blank" rel="noopener noreferrer">https://stackoverflow.com/questions/28615174/jq-filter-on-sub-object-value</a></li>
<li>final key: <a href="https://gist.github.com/olih/f7437fb6962fb3ee9fe95bda8d2c8fa4#gistcomment-3257810" target="_blank" rel="noopener noreferrer">https://gist.github.com/olih/f7437fb6962fb3ee9fe95bda8d2c8fa4#gistcomment-3257810</a></li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="script">Script<a href="#script" class="hash-link" aria-label="Direct link to Script" title="Direct link to Script">​</a></h3>
<p>I was able to replace the old utility:</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">function getIndexOfPodForPartitionInState()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  partition=&quot;$1&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  state=&quot;$2&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  pod=$(getGateway)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  namespace=$(getNamespace)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # To print the topology in the journal</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  until topology=&quot;$(kubectl exec &quot;$pod&quot; -n &quot;$namespace&quot; -- zbctl status --insecure)&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  do</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    true;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  done</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # For cluster size 3 and replication factor 3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # we know the following partition matrix</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # partition \ node  0    1     2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  #     1             L    F     F</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  #     2             F    L     F</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  #     3             F    F     L</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  #    etc.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # This means broker 1, 2 or 3 participates on partition 3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # BE AWARE the topology above is just an example and the leader can every node participating node.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  index=$(($(echo &quot;$topology&quot; \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    | grep &quot;Partition $partition&quot; \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    | grep -n &quot;$state&quot; -m 1 \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    | sed &#x27;s/\([0-9]*\).*/\1/&#x27;) - 1))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  echo &quot;$index&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>With this:</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">function getIndexOfPodForPartitionInState()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  partition=&quot;$1&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  state=&quot;$2&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  pod=$(getGateway)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  namespace=$(getNamespace)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # To print the topology in the journal</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  until topology=&quot;$(kubectl exec &quot;$pod&quot; -n &quot;$namespace&quot; -- zbctl status --insecure -o json)&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  do</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    true;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  done</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  index=$(echo &quot;$topology&quot; | jq &quot;[.brokers[]|select(.partitions[]| select(.partitionId == $partition) and .role == \&quot;$state\&quot;)][0].nodeId&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  echo &quot;$index&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The previous function worked only with homogeneous clusters, which means where the partitions are equally distributed. This caused issues on experiments on Production L clusters, where partitions are heterogeneous distributed, see related issue <a href="https://github.com/zeebe-io/zeebe-cluster-testbench/issues/154" target="_blank" rel="noopener noreferrer">zeebe-io/zeebe-cluster-testbench#154</a>. With this new utility we can create some new experiments also for Production - L clusters.</p>
<p>I wrote a new script based on the <a href="https://github.com/zeebe-io/zeebe-chaos/blob/master/chaos-experiments/scripts/disconnect-standalone-gateway.sh" target="_blank" rel="noopener noreferrer">older disconnect/connect gateway scripts</a>, where we disconnect the gateway with the brokers. The new one disconnects an leader for an partition with the follower and vice-versa.</p>
<p>Disconnect Leader-Follower:</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">#!/bin/bash</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set -exuo pipefail</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">source utils.sh</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">partition=1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">namespace=$(getNamespace)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">gateway=$(getGateway)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># determine leader for partition</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">index=$(getIndexOfPodForPartitionInState &quot;$partition&quot; &quot;LEADER&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">leader=$(getBroker &quot;$index&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">leaderIp=$(kubectl get pod &quot;$leader&quot; -n &quot;$namespace&quot; --template=&quot;{ {.status.podIP} }&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">index=$(getIndexOfPodForPartitionInState &quot;$partition&quot; &quot;FOLLOWER&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">follower=$(getBroker &quot;$index&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">followerIp=$(kubectl get pod &quot;$follower&quot; -n &quot;$namespace&quot; --template=&quot;{ {.status.podIP} }&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># To print the topology in the journal</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">retryUntilSuccess kubectl exec &quot;$gateway&quot; -n &quot;$namespace&quot; -- zbctl status --insecure</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># we put all into one function because we need to make sure that even after preemption the </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># dependency is installed</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">function disconnect() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> toChangedPod=&quot;$1&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> targetIp=&quot;$2&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> # update to have access to ip</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> kubectl exec -n &quot;$namespace&quot; &quot;$toChangedPod&quot; -- apt update</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> kubectl exec -n &quot;$namespace&quot; &quot;$toChangedPod&quot; -- apt install -y iproute2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> kubectl exec &quot;$toChangedPod&quot; -n &quot;$namespace&quot; -- ip route add unreachable &quot;$targetIp&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">retryUntilSuccess disconnect &quot;$leader&quot; &quot;$followerIp&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">retryUntilSuccess disconnect &quot;$follower&quot; &quot;$leaderIp&quot; </span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="chaos-experiment">Chaos Experiment<a href="#chaos-experiment" class="hash-link" aria-label="Direct link to Chaos Experiment" title="Direct link to Chaos Experiment">​</a></h2>
<p>We want to disconnect a leader and a follower from a specific partition.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="hypothesis">Hypothesis<a href="#hypothesis" class="hash-link" aria-label="Direct link to Hypothesis" title="Direct link to Hypothesis">​</a></h3>
<p>We expect that even if the leader and the follower can&#x27;t talk with each other the follower is not able to disrupt the cluster and no new election is started, such that he becomes the leader.
On reconnect we expect that the follower keeps up again and is eventually on the same page with the other follower and leader.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="actual">Actual<a href="#actual" class="hash-link" aria-label="Direct link to Actual" title="Direct link to Actual">​</a></h3>
<p>We deployed a cluster with one partition for simplicity. We run the above posted script to disconnect one leader with a follower and the same follower with the leader.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="disconnect">Disconnect<a href="#disconnect" class="hash-link" aria-label="Direct link to Disconnect" title="Direct link to Disconnect">​</a></h4>
<p>After running the disconnect script we see in general no disruption. The processing is still continuing.</p>
<p><img loading="lazy" src="/zeebe-chaos/assets/images/general-938c446793091f9fb5b8aa5c13435b01.png" width="2470" height="652" class="img_ev3q"></p>
<p>We can see that the followers misses a lot of heartbeats, which is expected.</p>
<p><img loading="lazy" src="/zeebe-chaos/assets/images/heartbeats-e178f780060b967d8c5748a7de390971.png" width="2473" height="571" class="img_ev3q"></p>
<p>This is also visible in the logs:</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">2021-01-07 20:22:28.320 CET</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">zeebe-chaos-zeebe-0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RaftServer{raft-partition-partition-1}{role=FOLLOWER} - No heartbeat from null in the last PT2.98S (calculated from last 2980 ms), sending poll requests</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2021-01-07 20:22:28.321 CET</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">zeebe-chaos-zeebe-0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RaftServer{raft-partition-partition-1}{role=FOLLOWER} - Poll request to 1 failed: io.netty.channel.AbstractChannel$AnnotatedConnectException: connect(..) failed: No route to host: zeebe-chaos-zeebe-1.zeebe-chaos-zeebe.zeebe-chaos.svc.cluster.local/10.0.0.7:26502</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2021-01-07 20:22:28.625 CET</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">zeebe-chaos-zeebe-1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RaftServer{raft-partition-partition-1} - AppendRequest{term=1, leader=1, prevLogIndex=2643199, prevLogTerm=1, entries=0, checksums=0, commitIndex=2755920} to 0 failed: java.util.concurrent.CompletionException: io.netty.channel.AbstractChannel$AnnotatedConnectException: connect(..) failed: No route to host: zeebe-chaos-zeebe-0.zeebe-chaos-zeebe.zeebe-chaos.svc.cluster.local/10.0.7.13:26502</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2021-01-07 20:22:28.977 CET</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">zeebe-chaos-zeebe-1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RaftServer{raft-partition-partition-1} - AppendRequest{term=1, leader=1, prevLogIndex=2643199, prevLogTerm=1, entries=0, checksums=0, commitIndex=2756276} to 0 failed: java.util.concurrent.CompletionException: io.netty.channel.AbstractChannel$AnnotatedConnectException: connect(..) failed: No route to host: zeebe-chaos-zeebe-0.zeebe-chaos-zeebe.zeebe-chaos.svc.cluster.local/10.0.7.13:26502</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2021-01-07 20:22:29.382 CET</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">zeebe-chaos-zeebe-1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RaftServer{raft-partition-partition-1} - AppendRequest{term=1, leader=1, prevLogIndex=2643199, prevLogTerm=1, entries=0, checksums=0, commitIndex=2756571} to 0 failed: java.util.concurrent.CompletionException: io.netty.channel.AbstractChannel$AnnotatedConnectException: connect(..) failed: No route to host: zeebe-chaos-zeebe-0.zeebe-chaos-zeebe.zeebe-chaos.svc.cluster.local/10.0.7.13:26502</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The follower is failing  to send poll requests to Broker-1, which is the leader. I assume we don&#x27;t see that the follower sends the other follower poll requests because our log level is to high.
Furthermore we can see that the leader is not able to send append requests. We have a panel where we can see how many entries the follower lags behind.</p>
<p><img loading="lazy" src="/zeebe-chaos/assets/images/slow-follower-91a64717a739d49ce14bd269b4bf9142.png" width="2464" height="196" class="img_ev3q"></p>
<p>Interesting that the java heap of the follower is growing.</p>
<p><img loading="lazy" src="/zeebe-chaos/assets/images/resources-follower-3f36ecf328d6f31df4a86fcb17dff4de.png" width="2466" height="658" class="img_ev3q"></p>
<p>But after some time GC steps in and it goes back to normal.</p>
<p><img loading="lazy" src="/zeebe-chaos/assets/images/later-gc-7c3d259d82ab97139cdcc22496ef3320.png" width="2471" height="349" class="img_ev3q"></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="connect">Connect<a href="#connect" class="hash-link" aria-label="Direct link to Connect" title="Direct link to Connect">​</a></h4>
<p>After running the connect script we can see in the log that almost immediately a snapshot is send to the follower.</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">D 2021-01-07T19:26:24.042908Z zeebe-chaos-zeebe-0 Consume snapshot snapshotChunk 000333.log of snapshot 2643199-1-1610047230637-3215713-3214967  zeebe-chaos-zeebe-0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">D 2021-01-07T19:26:24.045690Z zeebe-chaos-zeebe-0 Consume snapshot snapshotChunk 000334.sst of snapshot 2643199-1-1610047230637-3215713-3214967  zeebe-chaos-zeebe-0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">D 2021-01-07T19:26:24.052229Z zeebe-chaos-zeebe-0 Consume snapshot snapshotChunk 000335.log of snapshot 2643199-1-1610047230637-3215713-3214967  zeebe-chaos-zeebe-0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">D 2021-01-07T19:26:24.068270Z zeebe-chaos-zeebe-0 Consume snapshot snapshotChunk 000336.sst of snapshot 2643199-1-1610047230637-3215713-3214967  zeebe-chaos-zeebe-0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">D 2021-01-07T19:26:24.076135Z zeebe-chaos-zeebe-0 Consume snapshot snapshotChunk CURRENT of snapshot 2643199-1-1610047230637-3215713-3214967  zeebe-chaos-zeebe-0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">D 2021-01-07T19:26:24.081880Z zeebe-chaos-zeebe-0 Consume snapshot snapshotChunk MANIFEST-000003 of snapshot 2643199-1-1610047230637-3215713-3214967  zeebe-chaos-zeebe-0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">D 2021-01-07T19:26:24.089900Z zeebe-chaos-zeebe-0 Consume snapshot snapshotChunk OPTIONS-000090 of snapshot 2643199-1-1610047230637-3215713-3214967  zeebe-chaos-zeebe-0</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>This is also visible in the metrics</p>
<p><img loading="lazy" src="/zeebe-chaos/assets/images/raft-snap-3f95d18c325b9228ff52a4ae00ebc895.png" width="2467" height="526" class="img_ev3q"></p>
<p>We see a healed raft.</p>
<p><img loading="lazy" src="/zeebe-chaos/assets/images/healed-raft-523127360be6b5750d2d52428ed00e08.png" width="2476" height="879" class="img_ev3q"></p>
<p>What I was wondering is why the metric which shows the lag of the follower is not really recovering.</p>
<p><img loading="lazy" src="/zeebe-chaos/assets/images/metrics-is-not-correct-574cdd8d0d22b8d62145b132cdf10d1d.png" width="2482" height="189" class="img_ev3q"></p>
<p>Even after almost 12 hours it is still showing ~4K</p>
<p><img loading="lazy" src="/zeebe-chaos/assets/images/failing-metric-c363880bb7fb57b7dc9a40b01e86545d.png" width="1192" height="192" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="result">Result<a href="#result" class="hash-link" aria-label="Direct link to Result" title="Direct link to Result">​</a></h2>
<p>As we can see the experiment was successful, we were able to verify our hypothesis. The new extraction of the leader and follower from the topology gives us new possibilities for new chaos experiments.
I think we can also experiment a bit more with disconnecting different nodes, to see how the cluster behaves.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="new-issues">New Issues<a href="#new-issues" class="hash-link" aria-label="Direct link to New Issues" title="Direct link to New Issues">​</a></h2>
<ul>
<li>Metric: Follower lag doesn&#x27;t recover</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="participants">Participants<a href="#participants" class="hash-link" aria-label="Direct link to Participants" title="Direct link to Participants">​</a></h2>
<ul>
<li>@zelldon</li>
</ul></div><footer class="row docusaurus-mt-lg blogPostFooterDetailsFull_mRVl"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/zeebe-chaos/tags/availability">availability</a></li></ul></div><div class="col margin-top--sm"><a href="https://github.com/zeebe-io/zeebe-chaos/blob/master/chaos-days/blog/2021-01-07-disconnect-leader-and-follower/index.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Blog post page navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/zeebe-chaos/2021/01/19/network-partition"><div class="pagination-nav__sublabel">Newer Post</div><div class="pagination-nav__label">Network partitions</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/zeebe-chaos/2020/11/24/message-correlation-after-failover"><div class="pagination-nav__sublabel">Older Post</div><div class="pagination-nav__label">Message Correlation after Failover</div></a></nav></main><div class="col col--2"><div class="tableOfContents_bqdL thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#preparation" class="table-of-contents__link toc-highlight">Preparation</a><ul><li><a href="#resources" class="table-of-contents__link toc-highlight">Resources</a></li><li><a href="#script" class="table-of-contents__link toc-highlight">Script</a></li></ul></li><li><a href="#chaos-experiment" class="table-of-contents__link toc-highlight">Chaos Experiment</a><ul><li><a href="#hypothesis" class="table-of-contents__link toc-highlight">Hypothesis</a></li><li><a href="#actual" class="table-of-contents__link toc-highlight">Actual</a></li></ul></li><li><a href="#result" class="table-of-contents__link toc-highlight">Result</a></li><li><a href="#new-issues" class="table-of-contents__link toc-highlight">New Issues</a></li><li><a href="#participants" class="table-of-contents__link toc-highlight">Participants</a></li></ul></div></div></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://stackoverflow.com/questions/tagged/zeebe" target="_blank" rel="noopener noreferrer" class="footer__link-item">Stack Overflow<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://forum.camunda.io/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Forum<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://twitter.com/Camunda" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/zeebe-io/zeebe-chaos/" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2024 Zeebe Chaos. Built with Docusaurus.</div></div></div></footer></div>
</body>
</html>