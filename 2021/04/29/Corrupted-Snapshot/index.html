<!doctype html>
<html lang="en" dir="ltr" class="blog-wrapper blog-post-page plugin-blog plugin-id-default" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.5.1">
<title data-rh="true">Corrupted Snapshot Experiment Investigation | Zeebe Chaos</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://zeebe-io.github.io/zeebe-chaos/2021/04/29/Corrupted-Snapshot"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docusaurus_tag" content="default"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docsearch:docusaurus_tag" content="default"><meta data-rh="true" property="og:title" content="Corrupted Snapshot Experiment Investigation | Zeebe Chaos"><meta data-rh="true" name="description" content="A while ago we have written an experiment, which should verify that followers are not able to become leader, if they have a corrupted snapshot. You can find that specific experiment here. This experiment was executed regularly against Production-M and Production-S Camunda Cloud cluster plans. With the latest changes, in the upcoming 1.0 release, we changed some behavior in regard to detect snapshot corruption on followers."><meta data-rh="true" property="og:description" content="A while ago we have written an experiment, which should verify that followers are not able to become leader, if they have a corrupted snapshot. You can find that specific experiment here. This experiment was executed regularly against Production-M and Production-S Camunda Cloud cluster plans. With the latest changes, in the upcoming 1.0 release, we changed some behavior in regard to detect snapshot corruption on followers."><meta data-rh="true" property="og:type" content="article"><meta data-rh="true" property="article:published_time" content="2021-04-29T00:00:00.000Z"><meta data-rh="true" property="article:author" content="https://github.com/zelldon"><meta data-rh="true" property="article:tag" content="availability"><link data-rh="true" rel="icon" href="/zeebe-chaos/img/zeebe-logo.png"><link data-rh="true" rel="canonical" href="https://zeebe-io.github.io/zeebe-chaos/2021/04/29/Corrupted-Snapshot"><link data-rh="true" rel="alternate" href="https://zeebe-io.github.io/zeebe-chaos/2021/04/29/Corrupted-Snapshot" hreflang="en"><link data-rh="true" rel="alternate" href="https://zeebe-io.github.io/zeebe-chaos/2021/04/29/Corrupted-Snapshot" hreflang="x-default"><script data-rh="true" type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","@id":"https://zeebe-io.github.io/zeebe-chaos/2021/04/29/Corrupted-Snapshot","mainEntityOfPage":"https://zeebe-io.github.io/zeebe-chaos/2021/04/29/Corrupted-Snapshot","url":"https://zeebe-io.github.io/zeebe-chaos/2021/04/29/Corrupted-Snapshot","headline":"Corrupted Snapshot Experiment Investigation","name":"Corrupted Snapshot Experiment Investigation","description":"A while ago we have written an experiment, which should verify that followers are not able to become leader, if they have a corrupted snapshot. You can find that specific experiment here. This experiment was executed regularly against Production-M and Production-S Camunda Cloud cluster plans. With the latest changes, in the upcoming 1.0 release, we changed some behavior in regard to detect snapshot corruption on followers.","datePublished":"2021-04-29T00:00:00.000Z","author":{"@type":"Person","name":"Christopher Kujawa","description":"Chaos Engineer @ Zeebe","url":"https://github.com/zelldon","image":"https://github.com/zelldon.png"},"keywords":[],"isPartOf":{"@type":"Blog","@id":"https://zeebe-io.github.io/zeebe-chaos/","name":"Blog"}}</script><link rel="alternate" type="application/rss+xml" href="/zeebe-chaos/rss.xml" title="Zeebe Chaos RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/zeebe-chaos/atom.xml" title="Zeebe Chaos Atom Feed"><link rel="stylesheet" href="/zeebe-chaos/assets/css/styles.7f7b3e9a.css">
<script src="/zeebe-chaos/assets/js/runtime~main.f503f0c3.js" defer="defer"></script>
<script src="/zeebe-chaos/assets/js/main.324f0ee0.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const n=new URLSearchParams(window.location.search).entries();for(var[t,e]of n)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/zeebe-chaos/"><div class="navbar__logo"><img src="/zeebe-chaos/img/zeebe-logo.png" alt="Zeebe" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/zeebe-chaos/img/zeebe-logo.png" alt="Zeebe" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">Zeebe Chaos</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/zeebe-chaos/">Chaos Summaries</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/zeebe-io/zeebe-chaos" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_re4s thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_pO2u margin-bottom--md">All posts</div><div role="group"><h3 class="yearGroupHeading_rMGB">2024</h3><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zeebe-chaos/2024/08/19/Operate-improve-import-latency">Improve Operate import latency</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zeebe-chaos/2024/08/16/Operate-load-handling">Operate load handling</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zeebe-chaos/2024/07/25/Using-flow-control-to-handle-bottlenecked-exporting">Using flow control to handle bottleneck on exporting</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zeebe-chaos/2024/07/25/Using-flow-control-to-handle-uncontrolled-process-loops">Using flow control to handle uncontrolled process loops</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zeebe-chaos/2024/01/19/Job-Activation-Latency">Reducing the job activation delay</a></li></ul></div><div role="group"><h3 class="yearGroupHeading_rMGB">2023</h3><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zeebe-chaos/2023/12/20/Broker-scaling-performance">Broker Scaling and Performance</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zeebe-chaos/2023/12/19/Dynamic-Scaling-with-Dataloss">Dynamic Scaling with Dataloss</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zeebe-chaos/2023/12/18/Dynamically-scaling-brokers">Dynamically scaling brokers</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zeebe-chaos/2023/12/06/Job-Push-resiliency">Job push resiliency</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zeebe-chaos/2023/11/30/Job-push-overloading">Job push overloading</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zeebe-chaos/2023/11/07/Hot-backups-impact-on-processing">Hot backups impact on processing</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zeebe-chaos/2023/06/02/Using-Large-Multi-Instance">Using Large Multi-Instance</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zeebe-chaos/2023/05/19/Continuing-SST-Partitioning-toggle">Continuing SST Partitioning toggle</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zeebe-chaos/2023/05/15/SST-Partitioning-toggle">SST Partitioning toggle</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zeebe-chaos/2023/04/06/gateway-termination">Gateway Termination</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zeebe-chaos/2023/02/23/Recursive-call-activity">Recursive call activity</a></li></ul></div><div role="group"><h3 class="yearGroupHeading_rMGB">2022</h3><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zeebe-chaos/2022/08/31/Message-Correlation-after-Network-Partition">Message Correlation after Network Partition</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zeebe-chaos/2022/08/02/deployment-distribution">Bring Deployment distribution experiment back</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zeebe-chaos/2022/02/15/Standalone-Gateway-in-CCSaaS">Standalone Gateway in CCSaaS</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zeebe-chaos/2022/02/01/High-Snapshot-Frequency">High Snapshot Frequency</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zeebe-chaos/2022/01/19/big-variables">Handling of Big Variables</a></li></ul></div><div role="group"><h3 class="yearGroupHeading_rMGB">2021</h3><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zeebe-chaos/2021/11/24/Worker-count-should-not-impact-performance">Worker count should not impact performance</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zeebe-chaos/2021/11/11/Not-produce-duplicate-Keys">Not produce duplicate Keys</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zeebe-chaos/2021/10/29/Throughput-on-big-state">Throughput on big state</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zeebe-chaos/2021/10/05/recovery-time">Recovery (Fail Over) time</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zeebe-chaos/2021/09/23/Old-Clients">Old-Clients</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zeebe-chaos/2021/07/06/Slow-Network">Slow Network</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zeebe-chaos/2021/06/08/Full-Disk">Full Disk Recovery</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zeebe-chaos/2021/05/25/Reset-Clock">Time travel Experiment</a></li><li class="sidebarItem__DBe"><a aria-current="page" class="sidebarItemLink_mo7H sidebarItemLinkActive_I1ZP" href="/zeebe-chaos/2021/04/29/Corrupted-Snapshot">Corrupted Snapshot Experiment Investigation</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zeebe-chaos/2021/04/03/bpmn-meets-chaos-engineering">BPMN meets Chaos Engineering</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zeebe-chaos/2021/03/30/set-file-immutable">Set file immutable</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zeebe-chaos/2021/03/23/camunda-cloud-network-partition">Camunda Cloud network partition</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zeebe-chaos/2021/03/09/cont-workflow-instance">Fault-tolerant processing of process instances</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zeebe-chaos/2021/02/23/automate-deployments-dist">Automating Deployment Distribution Chaos Experiment</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zeebe-chaos/2021/01/26/deployments">Deployment Distribution</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zeebe-chaos/2021/01/19/network-partition">Network partitions</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zeebe-chaos/2021/01/07/disconnect-leader-and-follower">Disconnect Leader and one Follower</a></li></ul></div><div role="group"><h3 class="yearGroupHeading_rMGB">2020</h3><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zeebe-chaos/2020/11/24/message-correlation-after-failover">Message Correlation after Failover</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zeebe-chaos/2020/11/11/job-timeouts">Many Job Timeouts</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zeebe-chaos/2020/11/03/investigate-failing-tests">Investigate failing Chaos Tests</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zeebe-chaos/2020/10/20/non-graceful-shutdown">Non-graceful Shutdown Broker</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zeebe-chaos/2020/10/27/standalone-gw-memory">Gateway memory consumption</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zeebe-chaos/2020/10/13/multiple-leader-changes">Multiple Leader Changes</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zeebe-chaos/2020/10/06/toxi-proxy">Play around with ToxiProxy</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zeebe-chaos/2020/08/20/experiment-with-camunda-cloud">Experiment with Camunda Cloud</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zeebe-chaos/2020/08/06/low-load">Experiment with Low Load</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zeebe-chaos/2020/07/30/experiment-without-exporters">Experiment without Exporters</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zeebe-chaos/2020/07/16/big-multi-instance">Big Multi Instance</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zeebe-chaos/2020/07/09/timer-and-huge-variables">Experiment with Timers and Huge Variables</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zeebe-chaos/2020/07/02/extract-k8-resources">Extract K8 resources from namespace</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zeebe-chaos/2020/06/25/gateway-network-partition">Gateway Network Partition</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zeebe-chaos/2020/06/18/correlate-message-after-failover">Correlate Message after failover</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zeebe-chaos/2020/06/11/high-cpu-gateway">High CPU load on Standalone Gateway</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zeebe-chaos/2020/06/04/first-chaos-day">First Chaos Day!</a></li></ul></div></nav></aside><main class="col col--7"><article><header><h1 class="title_f1Hy">Corrupted Snapshot Experiment Investigation</h1><div class="container_mt6G margin-vert--md"><time datetime="2021-04-29T00:00:00.000Z">April 29, 2021</time> · <!-- -->8 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--12 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a class="avatar__photo-link" href="/zeebe-chaos/authors/zell"><img class="avatar__photo authorImage_XqGP" src="https://github.com/zelldon.png" alt="Christopher Kujawa"></a><div class="avatar__intro authorDetails_lV9A"><div class="avatar__name"><a href="/zeebe-chaos/authors/zell"><span class="authorName_yefp">Christopher Kujawa</span></a></div><small class="authorTitle_nd0D" title="Chaos Engineer @ Zeebe">Chaos Engineer @ Zeebe</small><div class="authorSocials_rSDt"></div></div></div></div></div></header><div id="__blog-post-container" class="markdown"><p>A while ago we have written an experiment, which should verify that followers are not able to become leader, if they have a corrupted snapshot. You can find that specific experiment <a href="https://github.com/zeebe-io/zeebe-chaos/tree/master/chaos-experiments/helm/snapshot-corruption" target="_blank" rel="noopener noreferrer">here</a>. This experiment was executed regularly against Production-M and Production-S Camunda Cloud cluster plans. With the latest changes, in the upcoming 1.0 release, we changed some behavior in regard to detect snapshot corruption on followers.</p>
<p><strong>NEW</strong> If a follower is restarted and has a corrupted snapshot it will detect it on bootstrap and will refuse to
start related services and crash. This means the pod will end in a crash loop, until this is manually fixed.</p>
<p><strong>OLD</strong> The follower only detects the corrupted snapshot on becoming leader when opening the database. On the restart of a follower this will not be detected.</p>
<p>The behavior change caused to fail our automated chaos experiments, since we corrupt the snapshot on followers and on a later experiment we restart followers. For this reason we had to disable the execution of the snapshot corruption experiment, see related issue
<a href="https://github.com/zeebe-io/zeebe-cluster-testbench/issues/303" target="_blank" rel="noopener noreferrer">zeebe-io/zeebe-cluster-testbench#303</a>.</p>
<p>In this chaos day we wanted to investigate whether we can improve the experiment and bring it back. For reference, I also opened a issue to discuss the current corruption detection approach <a href="https://github.com/camunda-cloud/zeebe/issues/6907" target="_blank" rel="noopener noreferrer">zeebe#6907</a></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="chaos-experiment">Chaos Experiment<a href="#chaos-experiment" class="hash-link" aria-label="Direct link to Chaos Experiment" title="Direct link to Chaos Experiment">​</a></h2>
<p>This time we look at an already existing experiment. I will run our normal setup and execute the experiment (each step) manually and observe what happens.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="experiment">Experiment<a href="#experiment" class="hash-link" aria-label="Direct link to Experiment" title="Direct link to Experiment">​</a></h3>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;version&quot;: &quot;0.1.0&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;title&quot;: &quot;Zeebe can recover from corrupted snapshots&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;description&quot;: &quot;Zeebe should be able to detect and recover from corrupted snapshot&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;contributions&quot;: {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;reliability&quot;: &quot;high&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;availability&quot;: &quot;high&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;steady-state-hypothesis&quot;: {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;title&quot;: &quot;Zeebe is alive&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;probes&quot;: [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;name&quot;: &quot;All pods should be ready&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;type&quot;: &quot;probe&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;tolerance&quot;: 0,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;provider&quot;: {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    &quot;type&quot;: &quot;process&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    &quot;path&quot;: &quot;verify-readiness.sh&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    &quot;timeout&quot;: 900</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;name&quot;: &quot;Should be able to create process instances on partition 3&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;type&quot;: &quot;probe&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;tolerance&quot;: 0,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;provider&quot;: {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    &quot;type&quot;: &quot;process&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    &quot;path&quot;: &quot;verify-steady-state.sh&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    &quot;arguments&quot;: &quot;3&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    &quot;timeout&quot;: 900</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;method&quot;: [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &quot;type&quot;: &quot;action&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &quot;name&quot;: &quot;Corrupt snapshots on followers&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &quot;provider&quot;: {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;type&quot;: &quot;process&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;path&quot;: &quot;corruptFollowers.sh&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;arguments&quot;: &quot;3&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &quot;type&quot;: &quot;action&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &quot;name&quot;: &quot;Terminate leader of partition 3&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &quot;provider&quot;: {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;type&quot;: &quot;process&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;path&quot;: &quot;shutdown-gracefully-partition.sh&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;arguments&quot;: [ &quot;Leader&quot;, &quot;3&quot; ]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ],</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;rollbacks&quot;: []</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>As written before we have our normal benchmark setup and I will run the referenced scripts manually and observe the behavior via grafana. The panels below show the base or steady state.
<img decoding="async" loading="lazy" alt="before-general" src="/zeebe-chaos/assets/images/before-general-c5e2d4a84d58bfe92397a1950bce66ab.png" width="1816" height="572" class="img_ev3q">
<img decoding="async" loading="lazy" alt="before-snap" src="/zeebe-chaos/assets/images/before-snap-af75897dcbf32d097c6a0e79300c23fd.png" width="1843" height="645" class="img_ev3q"></p>
<p>The first script we will run, corrupts for a certain partition the snapshots of all followers. It does it via just simply deleting some <code>*.sst</code> files.</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">[zell scripts/ cluster: zeebe-cluster ns:zell-chaos]$ ./corruptFollowers.sh 3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+ ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+ leader=zell-chaos-zeebe-1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+ followers=&#x27;zell-chaos-zeebe-0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">zell-chaos-zeebe-2&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+ ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+ kubectl -n zell-chaos exec zell-chaos-zeebe-0 -- ./corrupting.sh 3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+ partition=3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+ partitionDir=data/raft-partition/partitions/3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+ snapshotDir=(&quot;$partitionDir&quot;/snapshots/*)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">++ find data/raft-partition/partitions/3/snapshots/520492-1-1532470-1531619 -name &#x27;*.sst&#x27; -print -quit</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+ fileName=data/raft-partition/partitions/3/snapshots/520492-1-1532470-1531619/000110.sst</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+ rm data/raft-partition/partitions/3/snapshots/520492-1-1532470-1531619/000110.sst</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+ ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+ kubectl -n zell-chaos exec zell-chaos-zeebe-2 -- ./corrupting.sh 3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+ partition=3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+ partitionDir=data/raft-partition/partitions/3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+ snapshotDir=(&quot;$partitionDir&quot;/snapshots/*)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">++ find data/raft-partition/partitions/3/snapshots/520492-1-1532470-1531619 -name &#x27;*.sst&#x27; -print -quit</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+ fileName=data/raft-partition/partitions/3/snapshots/520492-1-1532470-1531619/000112.sst</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+ rm data/raft-partition/partitions/3/snapshots/520492-1-1532470-1531619/000112.sst</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The second script just terminated the Leader for the referenced partition.</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">[zell scripts/ cluster: zeebe-cluster ns:zell-chaos]$ ./terminate-partition.sh &quot;Leader&quot; 3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pod &quot;zell-chaos-zeebe-1&quot; deleted</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>On the first try we had the &quot;luck&quot; that there was a snapshot replication in between, such that the follower was able to become Leader, since it had again a valid snapshot.</p>
<p><img decoding="async" loading="lazy" alt="luck-general" src="/zeebe-chaos/assets/images/luck-general-6284a961fb55242e685ef99a31487f34.png" width="1841" height="649" class="img_ev3q">
<img decoding="async" loading="lazy" alt="luck-replication" src="/zeebe-chaos/assets/images/luck-replication-2564925f2731e3c9b5279a8db021b902.png" width="1832" height="649" class="img_ev3q"></p>
<p>On the second try we were actually able to reproduce the behavior we want to see. We have corrupted the snapshot and restarted the Leader and the partition can make only progress - if the previous leader comes back. This is because the others have a corrupted snapshot and can&#x27;t take over.</p>
<p><img decoding="async" loading="lazy" alt="no-luck-restart-general" src="/zeebe-chaos/assets/images/no-luck-restart-general-1f6e7cdad4128ad263669bf62557bb4f.png" width="1835" height="645" class="img_ev3q">
<img decoding="async" loading="lazy" alt="no-luck-restart" src="/zeebe-chaos/assets/images/no-luck-restart-556f37ee3d483e799428e83ad20d1aa5.png" width="1837" height="658" class="img_ev3q"></p>
<p>In all cases above we were able to make progress. The issue now arises when one of the affected follower is restarted. For our experiment I restarted Broker-2, which was at this point in time follower for Partition 3. After I restarted the follower it first looked like the partition one was completely down.</p>
<p><img decoding="async" loading="lazy" alt="follower-restart-partition-1" src="/zeebe-chaos/assets/images/follower-restart-partition-1-196eaa9f08944822a7eb9bc3e10b3aa1.png" width="1831" height="653" class="img_ev3q"></p>
<p>After serveral minutes the system recovered and continued.</p>
<p><img decoding="async" loading="lazy" alt="follower-restart-partition-1-cont" src="/zeebe-chaos/assets/images/follower-restart-partition-1-cont-9ea01572ab691821683a0145afeb5c80.png" width="1814" height="613" class="img_ev3q"></p>
<p>Via Grafana but also via <code>kubectl</code> we can see that the pod doesn&#x27;t become ready again.</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">zell-chaos-zeebe-0                          1/1     Running     0          13m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">zell-chaos-zeebe-1                          1/1     Running     0          17m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">zell-chaos-zeebe-2                          0/1     Running     0          5m4s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">zell-chaos-zeebe-gateway-854dd5dd5c-b8cpl   1/1     Running     0          45m</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">  Warning  Unhealthy               4m59s               kubelet                  Readiness probe failed: HTTP probe failed with statuscode: 503</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Warning  Unhealthy               9s (x30 over 5m9s)  kubelet                  Readiness probe failed: Get http://10.0.29.26:9600/ready: dial tcp 10.0.29.26:9600: connect: connection refused</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>In camunda cloud this will end in a crash loop, because we restart pods after 15 minutes if they are not ready in time. It is interesting to see that it seems not to restart by itself, <strong>which I had expected</strong>. After checking the logs we can also see why.</p>
<div class="language-md codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-md codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">I 2021-04-29T11:20:44.205851Z RaftServer{raft-partition-partition-1} - Server join completed. Waiting for the server to be READY </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token bold punctuation" style="color:#393A34">**</span><span class="token bold content">W 2021-04-29T11:20:44.220338Z Cannot load snapshot in /usr/local/zeebe/data/raft-partition/partitions/3/snapshots/1387684-4-4014493-4014014. The checksum stored does not match the checksum calculated.</span><span class="token bold punctuation" style="color:#393A34">**</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">D 2021-04-29T11:20:44.737724Z Loaded disk segment: 33 (raft-partition-partition-3-33.log) </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">D 2021-04-29T11:20:44.738579Z Found segment: 33 (raft-partition-partition-3-33.log) </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">D 2021-04-29T11:20:45.024028Z Loaded disk segment: 34 (raft-partition-partition-3-34.log) </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">D 2021-04-29T11:20:45.024688Z Found segment: 34 (raft-partition-partition-3-34.log) </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">E 2021-04-29T11:20:45.025826Z Bootstrap Broker-2 </span><span class="token url-reference url punctuation" style="color:#393A34">[</span><span class="token url-reference url variable" style="color:#36acaa">6/13</span><span class="token url-reference url punctuation" style="color:#393A34">]</span><span class="token url-reference url punctuation" style="color:#393A34">:</span><span class="token url-reference url" style="color:#36acaa"> cluster</span><span class="token plain"> services failed with unexpected exception. </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">I 2021-04-29T11:20:45.038260Z Closing Broker-2 </span><span class="token url-reference url punctuation" style="color:#393A34">[</span><span class="token url-reference url variable" style="color:#36acaa">1/5</span><span class="token url-reference url punctuation" style="color:#393A34">]</span><span class="token url-reference url punctuation" style="color:#393A34">:</span><span class="token url-reference url" style="color:#36acaa"> subscription</span><span class="token plain"> api </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">D 2021-04-29T11:20:45.040467Z Closing Broker-2 </span><span class="token url-reference url punctuation" style="color:#393A34">[</span><span class="token url-reference url variable" style="color:#36acaa">1/5</span><span class="token url-reference url punctuation" style="color:#393A34">]</span><span class="token url-reference url punctuation" style="color:#393A34">:</span><span class="token url-reference url" style="color:#36acaa"> subscription</span><span class="token plain"> api closed in 1 ms </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">I 2021-04-29T11:20:45.040926Z Closing Broker-2 </span><span class="token url-reference url punctuation" style="color:#393A34">[</span><span class="token url-reference url variable" style="color:#36acaa">2/5</span><span class="token url-reference url punctuation" style="color:#393A34">]</span><span class="token url-reference url punctuation" style="color:#393A34">:</span><span class="token url-reference url" style="color:#36acaa"> command</span><span class="token plain"> api handler </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">D 2021-04-29T11:20:45.042116Z Closing Broker-2 </span><span class="token url-reference url punctuation" style="color:#393A34">[</span><span class="token url-reference url variable" style="color:#36acaa">2/5</span><span class="token url-reference url punctuation" style="color:#393A34">]</span><span class="token url-reference url punctuation" style="color:#393A34">:</span><span class="token url-reference url" style="color:#36acaa"> command</span><span class="token plain"> api handler closed in 1 ms </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">I 2021-04-29T11:20:45.042524Z Closing Broker-2 </span><span class="token url-reference url punctuation" style="color:#393A34">[</span><span class="token url-reference url variable" style="color:#36acaa">3/5</span><span class="token url-reference url punctuation" style="color:#393A34">]</span><span class="token url-reference url punctuation" style="color:#393A34">:</span><span class="token url-reference url" style="color:#36acaa"> command</span><span class="token plain"> api transport </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">D 2021-04-29T11:20:46.163435Z Created segment: JournalSegment{id=2, index=1556849} </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">I 2021-04-29T11:20:47.065203Z Stopped </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">D 2021-04-29T11:20:47.066007Z Closing Broker-2 </span><span class="token url-reference url punctuation" style="color:#393A34">[</span><span class="token url-reference url variable" style="color:#36acaa">3/5</span><span class="token url-reference url punctuation" style="color:#393A34">]</span><span class="token url-reference url punctuation" style="color:#393A34">:</span><span class="token url-reference url" style="color:#36acaa"> command</span><span class="token plain"> api transport closed in 2023 ms </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">I 2021-04-29T11:20:47.066552Z Closing Broker-2 </span><span class="token url-reference url punctuation" style="color:#393A34">[</span><span class="token url-reference url variable" style="color:#36acaa">4/5</span><span class="token url-reference url punctuation" style="color:#393A34">]</span><span class="token url-reference url punctuation" style="color:#393A34">:</span><span class="token url-reference url" style="color:#36acaa"> membership</span><span class="token plain"> and replication protocol </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">E 2021-04-29T11:20:47.067664Z Closing Broker-2 </span><span class="token url-reference url punctuation" style="color:#393A34">[</span><span class="token url-reference url variable" style="color:#36acaa">4/5</span><span class="token url-reference url punctuation" style="color:#393A34">]</span><span class="token url-reference url punctuation" style="color:#393A34">:</span><span class="token url-reference url" style="color:#36acaa"> membership</span><span class="token plain"> and replication protocol failed to close. </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">I 2021-04-29T11:20:47.069050Z Closing Broker-2 </span><span class="token url-reference url punctuation" style="color:#393A34">[</span><span class="token url-reference url variable" style="color:#36acaa">5/5</span><span class="token url-reference url punctuation" style="color:#393A34">]</span><span class="token url-reference url punctuation" style="color:#393A34">:</span><span class="token url-reference url" style="color:#36acaa"> actor</span><span class="token plain"> scheduler </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">D 2021-04-29T11:20:47.069503Z Closing actor thread ground &#x27;Broker-2-zb-fs-workers&#x27; </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">D 2021-04-29T11:20:47.071276Z Closing actor thread ground &#x27;Broker-2-zb-fs-workers&#x27;: closed successfully </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">D 2021-04-29T11:20:47.071642Z Closing actor thread ground &#x27;Broker-2-zb-actors&#x27; </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">D 2021-04-29T11:20:47.073287Z Closing actor thread ground &#x27;Broker-2-zb-actors&#x27;: closed successfully </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">D 2021-04-29T11:20:47.074101Z Closing Broker-2 </span><span class="token url-reference url punctuation" style="color:#393A34">[</span><span class="token url-reference url variable" style="color:#36acaa">5/5</span><span class="token url-reference url punctuation" style="color:#393A34">]</span><span class="token url-reference url punctuation" style="color:#393A34">:</span><span class="token url-reference url" style="color:#36acaa"> actor</span><span class="token plain"> scheduler closed in 4 ms </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">I 2021-04-29T11:20:47.074468Z Closing Broker-2 succeeded. Closed 5 steps in 2036 ms. </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token bold punctuation" style="color:#393A34">**</span><span class="token bold content">E 2021-04-29T11:20:47.074845Z Failed to start broker 2!</span><span class="token bold punctuation" style="color:#393A34">**</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">I 2021-04-29T11:20:47.078669Z </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Error starting ApplicationContext. To display the conditions report re-run your application with &#x27;debug&#x27; enabled. </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token bold punctuation" style="color:#393A34">**</span><span class="token bold content">E 2021-04-29T11:20:47.093828Z Application run failed</span><span class="token bold punctuation" style="color:#393A34">**</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">I 2021-04-29T11:20:47.120419Z Shutting down ExecutorService &#x27;applicationTaskExecutor&#x27; </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">I 2021-04-29T11:20:47.132016Z RaftServer{raft-partition-partition-1}{role=FOLLOWER} - No heartbeat from null in the last PT2.926S (calculated from last 2926 ms), sending poll requests </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">I 2021-04-29T11:20:47.260582Z RaftServer{raft-partition-partition-1} - Found leader 0 </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">I 2021-04-29T11:20:47.262407Z RaftServer{raft-partition-partition-1} - Setting firstCommitIndex to 1507899. RaftServer is ready only after it has committed events upto this index </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">I 2021-04-29T11:20:47.263428Z RaftPartitionServer{raft-partition-partition-1} - Successfully started server for partition PartitionId{id=1, group=raft-partition} in 10098ms </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">D 2021-04-29T11:21:05.128572Z Created segment: JournalSegment{id=3, index=1570617} </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">D 2021-04-29T11:21:26.376398Z Created segment: JournalSegment{id=4, index=1584886} </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">I 2021-04-29T11:21:28.129677Z RaftPartitionServer{raft-partition-partition-2} - Successfully started server for partition PartitionId{id=2, group=raft-partition} in 51572ms </span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>We can see in the logs that the corruption is detected and the broker seems to stop, but actually it doesn&#x27;t.
After <code>Failed to start broker 2</code> the process should normally end. It looks like the thread for the other raft partitions are still running and continuing. This is a bug which I reported in one of my last chaos days,
see <a href="https://github.com/camunda-cloud/zeebe/issues/6702" target="_blank" rel="noopener noreferrer">camunda-cloud/zeebe#6702</a>.</p>
<p>With this current behavior we could easily fix the snapshot corruption experiments, since we just need a separate clean up step. It could look like this:</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"> k exec -it zell-chaos-zeebe-2 -- rm -r data/raft-partition/partitions/3 # remove partition three data</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> k delete pod zell-chaos-zeebe-2 # restart broker 2</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>I tried this and it worked, after some minutes the Broker-2 was able to come back.</p>
<p><img decoding="async" loading="lazy" alt="success-after-fix.png" src="/zeebe-chaos/assets/images/success-after-fix-6c7506d3368e85a046fc4d0745965292.png" width="1824" height="647" class="img_ev3q"></p>
<p>Why does it work you may ask. If we remove the corrupted partition data from the follower and restart it, then it will join the cluster with an empty state. The Leader for that partition will immediately replicate the snapshot for that partition, such that the follower is up to date again. This allows the follower then to bootstrap without issues again.</p>
<p>One problem with this approach we have if we actually fix the bug above, where we&#x27;re not shutting down, then we have the issue that we might not be able to access the data, since the pod is not up. I need to do some more research to solve this, but one possible solution I can think of would be to patch the <em>StatefulSet</em>, such that we can claim the PV via multiple pods. This would allow us to start a separate POD in order to access the data and delete it.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="found-bugs">Found Bugs<a href="#found-bugs" class="hash-link" aria-label="Direct link to Found Bugs" title="Direct link to Found Bugs">​</a></h2>
<ul>
<li>Broker is not shutting down properly <a href="https://github.com/camunda-cloud/zeebe/issues/6702" target="_blank" rel="noopener noreferrer">camunda-cloud/zeebe#6702</a></li>
</ul></div><footer class="docusaurus-mt-lg"><div class="row margin-top--sm theme-blog-footer-edit-meta-row"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/zeebe-chaos/tags/availability">availability</a></li></ul></div></div><div class="row margin-top--sm theme-blog-footer-edit-meta-row"><div class="col"><a href="https://github.com/zeebe-io/zeebe-chaos/blob/master/chaos-days/blog/2021-04-29-Corrupted-Snapshot/index.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_JAkA"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Blog post page navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/zeebe-chaos/2021/05/25/Reset-Clock"><div class="pagination-nav__sublabel">Newer Post</div><div class="pagination-nav__label">Time travel Experiment</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/zeebe-chaos/2021/04/03/bpmn-meets-chaos-engineering"><div class="pagination-nav__sublabel">Older Post</div><div class="pagination-nav__label">BPMN meets Chaos Engineering</div></a></nav></main><div class="col col--2"><div class="tableOfContents_bqdL thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#chaos-experiment" class="table-of-contents__link toc-highlight">Chaos Experiment</a><ul><li><a href="#experiment" class="table-of-contents__link toc-highlight">Experiment</a></li></ul></li><li><a href="#found-bugs" class="table-of-contents__link toc-highlight">Found Bugs</a></li></ul></div></div></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://stackoverflow.com/questions/tagged/zeebe" target="_blank" rel="noopener noreferrer" class="footer__link-item">Stack Overflow<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://forum.camunda.io/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Forum<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://twitter.com/Camunda" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/zeebe-io/zeebe-chaos/" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2024 Zeebe Chaos. Built with Docusaurus.</div></div></div></footer></div>
</body>
</html>