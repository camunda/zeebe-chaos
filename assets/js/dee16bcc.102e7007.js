"use strict";(self.webpackChunkzell_chaos=self.webpackChunkzell_chaos||[]).push([[2038],{34722:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>r,contentTitle:()=>s,default:()=>l,frontMatter:()=>o,metadata:()=>c,toc:()=>d});var i=n(74848),a=n(28453);const o={layout:"posts",title:"Camunda Cloud network partition",date:new Date("2021-03-23T00:00:00.000Z"),categories:["chaos_experiment","camunda_cloud","network"],authors:"zell"},s="Chaos Day Summary",c={permalink:"/zeebe-chaos/2021/03/23/camunda-cloud-network-partition",editUrl:"https://github.com/zeebe-io/zeebe-chaos/blob/master/chaos-days/blog/2021-03-23-camunda-cloud-network-partition/index.md",source:"@site/blog/2021-03-23-camunda-cloud-network-partition/index.md",title:"Camunda Cloud network partition",description:"This time Deepthi was joining me on my regular Chaos Day.",date:"2021-03-23T00:00:00.000Z",tags:[],readingTime:7.18,hasTruncateMarker:!0,authors:[{name:"Christopher Kujawa",title:"Chaos Engineer @ Zeebe",url:"https://github.com/zelldon",imageURL:"https://github.com/zelldon.png",key:"zell",page:null}],frontMatter:{layout:"posts",title:"Camunda Cloud network partition",date:"2021-03-23T00:00:00.000Z",categories:["chaos_experiment","camunda_cloud","network"],authors:"zell"},unlisted:!1,prevItem:{title:"Set file immutable",permalink:"/zeebe-chaos/2021/03/30/set-file-immutable"},nextItem:{title:"Fault-tolerant processing of process instances",permalink:"/zeebe-chaos/2021/03/09/cont-workflow-instance"}},r={authorsImageUrls:[void 0]},d=[{value:"Chaos Experiment",id:"chaos-experiment",level:2},{value:"Enhancement",id:"enhancement",level:3},{value:"Verification",id:"verification",level:3},{value:"Testbench",id:"testbench",level:3},{value:"Found Bugs",id:"found-bugs",level:4},{value:"Re-connecting might fail",id:"re-connecting-might-fail",level:5}];function h(e){const t={a:"a",code:"code",em:"em",h2:"h2",h3:"h3",h4:"h4",h5:"h5",p:"p",pre:"pre",strong:"strong",...(0,a.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsxs)(t.p,{children:["This time ",(0,i.jsx)(t.a,{href:"https://github.com/deepthidevaki",children:"Deepthi"})," was joining me on my regular Chaos Day. ","\ud83c\udf89"]}),"\n",(0,i.jsxs)(t.p,{children:[(0,i.jsx)(t.a,{href:"/zeebe-chaos/2021/02/23/automate-deployments-dist",children:"In the second last chaos day"})," I created an automated chaos experiment, which verifies that the deployments are distributed after a network partition. Later it turned out that this doesn't work for camunda cloud, only for our helm setup. ",(0,i.jsx)(t.a,{href:"https://github.com/zeebe-io/zeebe-cluster-testbench/issues/237",children:"The issue"})," was that on our camunda cloud zeebe clusters we had no ",(0,i.jsx)(t.a,{href:"https://man7.org/linux/man-pages/man7/capabilities.7.html",children:"NET_ADMIN"})," capability to create ip routes (used for the network partitions). After discussing with our SRE's they proposed a good way to overcome this. On running chaos experiments, which are network related, we will patch our target cluster to add this capability. This means we don't need to add such functionality in camunda cloud and the related zeebe operate/controller. Big thanks to ",(0,i.jsx)(t.a,{href:"https://github.com/hisImminence",children:"Immi"})," and ",(0,i.jsx)(t.a,{href:"https://github.com/Faffnir",children:"David"})," for providing this fix."]}),"\n",(0,i.jsx)(t.p,{children:(0,i.jsx)(t.strong,{children:"TL;DR;"})}),"\n",(0,i.jsx)(t.p,{children:"We were able to enhance the deployment distribution experiment and run it in the camunda cloud via testbench. We have enabled the experiment for Production M and L cluster plans. We had to adjust the rights for the testbench service account to make this work."}),"\n",(0,i.jsx)(t.h2,{id:"chaos-experiment",children:"Chaos Experiment"}),"\n",(0,i.jsxs)(t.p,{children:["We already had a ",(0,i.jsx)(t.a,{href:"https://github.com/zeebe-io/zeebe-chaos/blob/master/chaos-experiments/helm/deployment-distribution/experiment.json",children:"prepared chaos experiment"}),", but we needed to enhance that. Deepthi was so kind to create ",(0,i.jsx)(t.a,{href:"https://github.com/zeebe-io/zeebe-chaos/pull/50",children:"PR"})," for that."]}),"\n",(0,i.jsx)(t.h3,{id:"enhancement",children:"Enhancement"}),"\n",(0,i.jsxs)(t.p,{children:["The changes contain a new step before creating the network partition on the deployment distribution experiment, see ",(0,i.jsx)(t.a,{href:"https://github.com/zeebe-io/zeebe-chaos/blob/master/chaos-experiments/camunda-cloud/production-l/deployment-distribution/experiment.json#L25-L35",children:"here"}),"."]}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-json",children:'        {\n            "type": "action",\n            "name": "Enable net_admin capabilities",\n            "provider": {\n                "type": "process",\n                "path": "apply_net_admin.sh"\n            },\n            "pauses": {\n                "after": 180\n            }\n        }\n'})}),"\n",(0,i.jsxs)(t.p,{children:["The ",(0,i.jsx)(t.code,{children:"apply_net_admin.sh"})," contains the following code:"]}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-shell",children:'\n#!/bin/bash\nset -euo pipefail\n\nscriptPath=$( cd "$(dirname "${BASH_SOURCE[0]}")" ; pwd -P )\nsource utils.sh\n\nnamespace=$(getNamespace)\n\nCLUSTERID=${namespace%-zeebe}\n\nkubectl patch zb "$CLUSTERID" --type merge --patch=\'{"spec":{"controller":{"reconcileDisabled":true}}}\'\nkubectl patch statefulset zeebe -n "$namespace" --patch "$(cat $scriptPath/net_admin_patch.yaml)"\n'})}),"\n",(0,i.jsxs)(t.p,{children:["It disables reconciliation for the target zeebe cluster and applies the following patch, which adds the ",(0,i.jsx)(t.code,{children:"NET_ADMIN"})," capability:"]}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-yaml",children:'spec:\n  template:\n    spec:\n      containers:\n        - name: "zeebe"\n          securityContext:\n            capabilities:\n              add:\n                - "NET_ADMIN"\n'})}),"\n",(0,i.jsxs)(t.p,{children:["Big thanks to ",(0,i.jsx)(t.a,{href:"https://github.com/hisImminence",children:"Immi"})," and ",(0,i.jsx)(t.a,{href:"https://github.com/Faffnir",children:"David"})," for providing this fix."]}),"\n",(0,i.jsx)(t.p,{children:"After we applied the patch, we need to make sure that the all pods are restarted and have the requested change. This is the reason we wait after the action for some minutes. This was the easiest way for us to think of, but ideally we find a better way here to make sure the patch was applied and we can continue."}),"\n",(0,i.jsx)(t.h3,{id:"verification",children:"Verification"}),"\n",(0,i.jsxs)(t.p,{children:["We run this experiment with a Production L cluster (v1.0.0-alpha2) and it succeeded. This is quite nice, because this also contains already the rewritten ",(0,i.jsx)(t.a,{href:"https://github.com/camunda-cloud/zeebe/issues/6173",children:"deployment distribution"})," logic."]}),"\n",(0,i.jsxs)(t.p,{children:["To verify whether the experiment really does something we checked the metrics and the logs. In the metrics we were not really able to tell that there was a network partition going on. There were no heart beats missing. The reason for that was that in the experiment the Leader for partition 3 (Node 1) and Leader for partition 1 (Node 0) have been disconnected. If we check the ",(0,i.jsx)(t.a,{href:"https://github.com/camunda-cloud/zeebe/blob/develop/benchmarks/docs/scripts/partitionDistribution.sh",children:"partition distribution"})," we can see that they have no partitions in common."]}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-shell",children:"$ ./partitionDistribution.sh 6 8 3\nDistribution:\nP\\N|\tN 0|\tN 1|\tN 2|\tN 3|\tN 4|\tN 5\nP 0|\tL  |\tF  |\tF  |\t-  |\t-  |\t-  \nP 1|\t-  |\tL  |\tF  |\tF  |\t-  |\t-  \nP 2|\t-  |\t-  |\tL  |\tF  |\tF  |\t-  \nP 3|\t-  |\t-  |\t-  |\tL  |\tF  |\tF  \nP 4|\tF  |\t-  |\t-  |\t-  |\tL  |\tF  \nP 5|\tF  |\tF  |\t-  |\t-  |\t-  |\tL  \nP 6|\tL  |\tF  |\tF  |\t-  |\t-  |\t-  \nP 7|\t-  |\tL  |\tF  |\tF  |\t-  |\t-  \n\nPartitions per Node:\nN 0: 4\nN 1: 5\nN 2: 5\nN 3: 4\nN 4: 3\nN 5: 3\n"})}),"\n",(0,i.jsx)(t.p,{children:"Fortunately we saw in the logs that the Node 1, was retrying to send the deployments and at some point it succeeds."}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-shell",children:"2021-03-23 13:11:54.163 CET\nFailed to receive deployment response for partitions [2, 4, 7, 8] (topic 'deployment-response-2251799813685304'). Retrying\n2021-03-23 13:11:54.164 CET\nPushed deployment 2251799813685304 to all partitions.\n2021-03-23 13:11:54.164 CET\nDeployment CREATE command for deployment 2251799813685304 was written on partition 2\n2021-03-23 13:11:54.164 CET\nDeployment CREATE command for deployment 2251799813685304 was written on partition 4\n2021-03-23 13:11:54.164 CET\nDeployment CREATE command for deployment 2251799813685304 was written on partition 8\n2021-03-23 13:11:54.165 CET\nDeployment CREATE command for deployment 2251799813685304 was written on partition 7\n2021-03-23 13:11:54.175 CET\nDeployment 2251799813685304 distributed to all partitions successfully.\n2021-03-23 13:11:54.763 CET\nFailed to receive deployment response for partitions [2, 4, 7, 8] (topic 'deployment-response-2251799813685306'). Retrying\n2021-03-23 13:11:54.764 CET\nPushed deployment 2251799813685306 to all partitions.\n2021-03-23 13:11:54.764 CET\nDeployment CREATE command for deployment 2251799813685306 was written on partition 4\n2021-03-23 13:11:54.764 CET\nDeployment CREATE command for deployment 2251799813685306 was written on partition 2\n2021-03-23 13:11:54.765 CET\nDeployment CREATE command for deployment 2251799813685306 was written on partition 8\n2021-03-23 13:11:54.765 CET\nDeployment CREATE command for deployment 2251799813685306 was written on partition 7\n2021-03-23 13:11:54.773 CET\nDeployment 2251799813685306 distributed to all partitions successfully.\n"})}),"\n",(0,i.jsx)(t.h3,{id:"testbench",children:"Testbench"}),"\n",(0,i.jsx)(t.p,{children:"After the experiment has succeeded and we had verified the execution we run this again on testbench."}),"\n",(0,i.jsxs)(t.p,{children:["We saw a non completing chaos worker after checking the chaostoolkit logs, we saw that it was still in the phase of disconnecting the nodes, which was the same issue as before ",(0,i.jsx)(t.a,{href:"https://github.com/zeebe-io/zeebe-cluster-testbench/issues/237",children:"#237"}),"."]}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-shell",children:"[2021-03-23 12:40:24 INFO] [activity:161] Action: Enable net_admin capabilities\n[2021-03-23 12:40:24 DEBUG] [process:53] Running: ['/home/chaos/zeebe-chaos/chaos-experiments/camunda-cloud/../scripts/apply_net_admin.sh']\n[2021-03-23 12:40:24 WARNING] [process:66] This process returned a non-zero exit code. This may indicate some error and not what you expected. Please have a look at the logs.\n[2021-03-23 12:40:24 DEBUG] [__init__:142] Data encoding detected as 'ascii' with a confidence of 1.0\n[2021-03-23 12:40:24 DEBUG] [activity:180]   => succeeded with '{'status': 1, 'stdout': '', 'stderr': 'Error from server (Forbidden): zeebeclusters.cloud.camunda.io \"cc108db7-768c-45cc-a6c5-098dc28f260c\" is forbidden: User \"system:serviceaccount:zeebe-chaos:zeebe-chaos-sa\" cannot get resource \"zeebeclusters\" in API group \"cloud.camunda.io\" at the cluster scope\\n'}'\n[2021-03-23 12:40:24 INFO] [activity:198] Pausing after activity for 180s...\n[2021-03-23 12:43:24 DEBUG] [__init__:355] No controls to apply on 'activity'\n[2021-03-23 12:43:24 DEBUG] [__init__:355] No controls to apply on 'activity'\n[2021-03-23 12:43:24 INFO] [activity:161] Probe: All pods should be ready\n[2021-03-23 12:43:24 DEBUG] [process:53] Running: ['/home/chaos/zeebe-chaos/chaos-experiments/camunda-cloud/../scripts/verify-readiness.sh']\n[2021-03-23 12:43:24 DEBUG] [__init__:142] Data encoding detected as 'ascii' with a confidence of 1.0\n[2021-03-23 12:43:24 DEBUG] [__init__:142] Data encoding detected as 'ascii' with a confidence of 1.0\n[2021-03-23 12:43:24 DEBUG] [activity:180]   => succeeded with '{'status': 0, 'stdout': 'pod/zeebe-0 condition met\\npod/zeebe-1 condition met\\npod/zeebe-2 condition met\\npod/zeebe-3 condition met\\npod/zeebe-4 condition met\\npod/zeebe-5 condition met\\n', 'stderr': \"+ source utils.sh\\n++ CHAOS_SETUP=cloud\\n++ getNamespace\\n+++ kubectl config view --minify --output 'jsonpath={..namespace}'\\n++ namespace=cc108db7-768c-45cc-a6c5-098dc28f260c-zeebe\\n++ echo cc108db7-768c-45cc-a6c5-098dc28f260c-zeebe\\n+ namespace=cc108db7-768c-45cc-a6c5-098dc28f260c-zeebe\\n+ '[' cloud == cloud ']'\\n+ kubectl wait --for=condition=Ready pod -l app.kubernetes.io/app=zeebe --timeout=900s -n cc108db7-768c-45cc-a6c5-098dc28f260c-zeebe\\n\"}'\n[2021-03-23 12:43:24 DEBUG] [__init__:355] No controls to apply on 'activity'\n[2021-03-23 12:43:24 DEBUG] [__init__:355] No controls to apply on 'activity'\n[2021-03-23 12:43:24 INFO] [activity:161] Action: Create network partition between leaders\n[2021-03-23 12:43:24 DEBUG] [process:53] Running: ['/home/chaos/zeebe-chaos/chaos-experiments/camunda-cloud/../scripts/disconnect-leaders.sh']\n"})}),"\n",(0,i.jsxs)(t.p,{children:["In the logs we also saw that the patch didn't worked as expected with the used service account, so we need to fix here the permission and after that it should hopefully work. ","\ud83e\udd1e"]}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-shell",children:'\'Error from server (Forbidden): zeebeclusters.cloud.camunda.io "XXX" is forbidden: User "system:serviceaccount:zeebe-chaos:zeebe-chaos-sa" cannot get resource "zeebeclusters" in API group "cloud.camunda.io" at the cluster scope\\n\'\n'})}),"\n",(0,i.jsxs)(t.p,{children:["After checking with Immi, we were sure that we need to adjust the ",(0,i.jsx)(t.a,{href:"https://github.com/zeebe-io/zeebe-cluster-testbench/blob/develop/core/chaos-workers/deployment/service-account/zeebe-chaos-role.yaml#L9",children:"serviceaccount roles"}),". After changing the apiGroups to ",(0,i.jsx)(t.code,{children:'["*"]'})," the experiments are running in testbench and the patch can be applied. We can now see in the log the following:"]}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-shell",children:"[2021-03-23 14:21:24 DEBUG] [process:53] Running: ['/home/chaos/zeebe-chaos/chaos-experiments/camunda-cloud/../scripts/apply_net_admin.sh']\n[2021-03-23 14:21:25 DEBUG] [__init__:142] Data encoding detected as 'ascii' with a confidence of 1.0\n[2021-03-23 14:21:25 DEBUG] [activity:180]   => succeeded with '{'status': 0, 'stdout': 'zeebecluster.cloud.camunda.io/cc108db7-768c-45cc-a6c5-098dc28f260c patched\\nstatefulset.apps/zeebe patched\\n', 'stderr': ''}'\n"})}),"\n",(0,i.jsxs)(t.p,{children:["Thanks for participating ",(0,i.jsx)(t.a,{href:"https://github.com/deepthidevaki",children:"Deepthi"}),"."]}),"\n",(0,i.jsx)(t.h4,{id:"found-bugs",children:"Found Bugs"}),"\n",(0,i.jsx)(t.h5,{id:"re-connecting-might-fail",children:"Re-connecting might fail"}),"\n",(0,i.jsxs)(t.p,{children:["We realized during testing the experiment that the re-connecting might fail, because the pod can be rescheduled and then a ip route can't be delete since it no longer exist. ",(0,i.jsx)(t.a,{href:"https://github.com/zeebe-io/zeebe-chaos/blob/master/chaos-experiments/scripts/connect-leaders.sh#L45-L48",children:"This is now fixed"}),". We check for existence of the command ",(0,i.jsx)(t.code,{children:"ip"}),", if this doesn't exist we know the pod was restarted and we ignore it."]}),"\n",(0,i.jsx)(t.p,{children:(0,i.jsx)(t.em,{children:"Before:"})}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-shell",children:'function connect() {\n toChangedPod="$1"\n targetIp="$2"\n\n # update to have access to ip\n kubectl exec -n "$namespace" "$toChangedPod" -- apt update\n kubectl exec -n "$namespace" "$toChangedPod" -- apt install -y iproute2\n kubectl exec "$toChangedPod" -n "$namespace" -- ip route del unreachable "$targetIp"\n\n}\n'})}),"\n",(0,i.jsx)(t.p,{children:(0,i.jsx)(t.em,{children:"After:"})}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-shell",children:'\nfunction connect() {\n toChangedPod="$1"\n targetIp="$2"\n\n if command -v ip\n then\n     kubectl exec "$toChangedPod" -n "$namespace" -- ip route del unreachable "$targetIp"\n fi\n}\n'})})]})}function l(e={}){const{wrapper:t}={...(0,a.R)(),...e.components};return t?(0,i.jsx)(t,{...e,children:(0,i.jsx)(h,{...e})}):h(e)}},28453:(e,t,n)=>{n.d(t,{R:()=>s,x:()=>c});var i=n(96540);const a={},o=i.createContext(a);function s(e){const t=i.useContext(o);return i.useMemo((function(){return"function"==typeof e?e(t):{...t,...e}}),[t,e])}function c(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(a):e.components||a:s(e.components),i.createElement(o.Provider,{value:t},e.children)}}}]);