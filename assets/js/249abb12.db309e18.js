"use strict";(self.webpackChunkzell_chaos=self.webpackChunkzell_chaos||[]).push([[9638],{37121:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>l,contentTitle:()=>s,default:()=>h,frontMatter:()=>r,metadata:()=>i,toc:()=>c});var o=n(74848),a=n(28453);const r={layout:"posts",title:"Non-graceful Shutdown Broker",date:new Date("2020-10-20T00:00:00.000Z"),categories:["chaos_experiment","broker"],authors:"zell"},s="Chaos Day Summary",i={permalink:"/zeebe-chaos/2020/10/20/non-graceful-shutdown",editUrl:"https://github.com/zeebe-io/zeebe-chaos/blob/master/chaos-days/blog/2020-10-20-non-graceful-shutdown/index.md",source:"@site/blog/2020-10-20-non-graceful-shutdown/index.md",title:"Non-graceful Shutdown Broker",description:"Today I had not much time for the chaos day, because of writing Gameday Summary, Incident review, taking part of incidents etc. So enough chaos for one day :)",date:"2020-10-20T00:00:00.000Z",tags:[],readingTime:1.83,hasTruncateMarker:!0,authors:[{name:"Christopher Kujawa",title:"Chaos Engineer @ Zeebe",url:"https://github.com/zelldon",imageURL:"https://github.com/zelldon.png",key:"zell",page:null}],frontMatter:{layout:"posts",title:"Non-graceful Shutdown Broker",date:"2020-10-20T00:00:00.000Z",categories:["chaos_experiment","broker"],authors:"zell"},unlisted:!1,prevItem:{title:"Investigate failing Chaos Tests",permalink:"/zeebe-chaos/2020/11/03/investigate-failing-tests"},nextItem:{title:"Gateway memory consumption",permalink:"/zeebe-chaos/2020/10/27/standalone-gw-memory"}},l={authorsImageUrls:[void 0]},c=[{value:"PR Merge",id:"pr-merge",level:2},{value:"Non-graceful shutdown",id:"non-graceful-shutdown",level:2},{value:"Participants",id:"participants",level:2}];function d(e){const t={a:"a",code:"code",h2:"h2",li:"li",p:"p",pre:"pre",ul:"ul",...(0,a.R)(),...e.components};return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)(t.p,{children:"Today I had not much time for the chaos day, because of writing Gameday Summary, Incident review, taking part of incidents etc. So enough chaos for one day :)"}),"\n",(0,o.jsx)(t.p,{children:"But I wanted to merge the PR from Peter and test how our brokers behave if they are not gracefully shutdown.\nI did that on Wednesday (21-10-2020)."}),"\n",(0,o.jsx)(t.h2,{id:"pr-merge",children:"PR Merge"}),"\n",(0,o.jsxs)(t.p,{children:["I tried again the new chaos experiment with a Production M cluster, before merging. It worked quite smooth.\nPR is merged ",(0,o.jsx)(t.a,{href:"https://github.com/zeebe-io/zeebe-chaos/pull/41",children:"#41"})," ","\ud83c\udf89"]}),"\n",(0,o.jsx)(t.h2,{id:"non-graceful-shutdown",children:"Non-graceful shutdown"}),"\n",(0,o.jsxs)(t.p,{children:["Currently in our experiments we do a normal ",(0,o.jsx)(t.code,{children:"kubectl delete pod"}),", which does an graceful shutdown. The application has time to stop it's services etc. It would be interesting how Zeebe handles non-graceful shutdowns. In order to achieve that we can use the option ",(0,o.jsx)(t.code,{children:"--grace-period=0"}),". For more information you can read for example ",(0,o.jsx)(t.a,{href:"https://kubernetes.io/docs/tasks/run-application/force-delete-stateful-set-pod/#force-deletion",children:"this"})]}),"\n",(0,o.jsxs)(t.p,{children:["I added additional experiments to our normal follower and leader restarts experiments, such that we have both graceful and non-graceful restarts.\nBoth seem to work without any issues. I was also able to fix some bash script error with the help of ",(0,o.jsx)(t.a,{href:"https://github.com/koalaman/shellcheck",children:"shellcheck"}),". Related issue ",(0,o.jsx)(t.a,{href:"https://github.com/zeebe-io/zeebe-chaos/issues/42",children:"https://github.com/zeebe-io/zeebe-chaos/issues/42"}),"."]}),"\n",(0,o.jsx)(t.p,{children:"Example output:"}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{children:"(chaostk) [zell kubernetes/ ns:f45d4dee-f73a-4733-9cd4-a4aa8b022376-zeebe]$ chaos run leader-terminate/experiment.json \n[2020-10-21 15:57:23 INFO] Validating the experiment's syntax\n[2020-10-21 15:57:23 INFO] Experiment looks valid\n[2020-10-21 15:57:23 INFO] Running experiment: Zeebe Leader restart non-graceful experiment\n[2020-10-21 15:57:23 INFO] Steady-state strategy: default\n[2020-10-21 15:57:23 INFO] Rollbacks strategy: default\n[2020-10-21 15:57:23 INFO] Steady state hypothesis: Zeebe is alive\n[2020-10-21 15:57:23 INFO] Probe: All pods should be ready\n[2020-10-21 15:57:23 INFO] Probe: Should be able to create workflow instances on partition 3\n[2020-10-21 15:57:27 INFO] Steady state hypothesis is met!\n[2020-10-21 15:57:27 INFO] Playing your experiment's method now...\n[2020-10-21 15:57:27 INFO] Action: Terminate leader of partition 3 non-gracefully\n[2020-10-21 15:57:33 INFO] Steady state hypothesis: Zeebe is alive\n[2020-10-21 15:57:33 INFO] Probe: All pods should be ready\n[2020-10-21 15:58:28 INFO] Probe: Should be able to create workflow instances on partition 3\n[2020-10-21 15:58:32 INFO] Steady state hypothesis is met!\n[2020-10-21 15:58:32 INFO] Let's rollback...\n[2020-10-21 15:58:32 INFO] No declared rollbacks, let's move on.\n[2020-10-21 15:58:32 INFO] Experiment ended with status: completed\n"})}),"\n",(0,o.jsx)(t.p,{children:"Related commits:"}),"\n",(0,o.jsxs)(t.ul,{children:["\n",(0,o.jsx)(t.li,{children:(0,o.jsx)(t.a,{href:"https://github.com/zeebe-io/zeebe-chaos/commit/e6260cb8612a983c8ed74fd2a37a249987ad3d3d",children:"Restart leader non-gracefully"})}),"\n",(0,o.jsx)(t.li,{children:(0,o.jsx)(t.a,{href:"https://github.com/zeebe-io/zeebe-chaos/commit/63c481c0c7dd7026f03be4e51d61a918613b0140",children:"Restart follower non-gracefully"})}),"\n"]}),"\n",(0,o.jsx)(t.h2,{id:"participants",children:"Participants"}),"\n",(0,o.jsxs)(t.ul,{children:["\n",(0,o.jsx)(t.li,{children:"@zelldon"}),"\n"]})]})}function h(e={}){const{wrapper:t}={...(0,a.R)(),...e.components};return t?(0,o.jsx)(t,{...e,children:(0,o.jsx)(d,{...e})}):d(e)}},28453:(e,t,n)=>{n.d(t,{R:()=>s,x:()=>i});var o=n(96540);const a={},r=o.createContext(a);function s(e){const t=o.useContext(r);return o.useMemo((function(){return"function"==typeof e?e(t):{...t,...e}}),[t,e])}function i(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(a):e.components||a:s(e.components),o.createElement(r.Provider,{value:t},e.children)}}}]);